<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Admin - Booking System</title>
<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
.admin-container { 
  max-width: 760px; 
  margin: 20px auto; 
  padding: clamp(16px, 5vw, 28px); 
  background: #fff; 
  border-radius: 12px; 
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

h1 {
  text-align: center;
  margin-bottom: clamp(16px, 4vh, 24px);
  font-size: clamp(1.3rem, 5vw, 1.8rem);
}

.admin-slots { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(clamp(65px, 12vw, 90px), 1fr)); 
  gap: clamp(6px, 1.5vw, 10px); 
  margin-bottom: 10px;
}

.admin-slot { 
  padding: clamp(8px, 2vw, 12px); 
  text-align: center; 
  border: 1px solid #ccc; 
  border-radius: 8px; 
  cursor: pointer;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(0.75rem, 2vw, 0.9rem);
  transition: all 0.2s ease;
  touch-action: manipulation;
}

.admin-slot:active {
  transform: scale(0.95);
}

.admin-slot.selected { 
  background: #000;
  color: #fff;
  font-weight: 600;
}

.bookings { margin-top: 15px; }

.booking-card { 
  padding: clamp(10px, 2.5vw, 14px); 
  border: 1px solid #ccc; 
  border-radius: 8px; 
  margin-bottom: 8px; 
  display: flex; 
  justify-content: space-between; 
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}

.booking-actions button { 
  margin-left: 5px; 
  padding: clamp(6px, 1.5vw, 10px) clamp(8px, 2vw, 14px); 
  border: none;
  border-radius: 6px; 
  cursor: pointer;
  min-height: 40px;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
}

.booking-actions .confirm { background: #4CAF50; color: #fff; }
.booking-actions .delete { background: #f44336; color: #fff; }

/* All Bookings Section - Modern Styling */
#allBookingsSection {
  margin-top: clamp(20px, 5vh, 30px);
  padding: clamp(16px, 4vw, 24px);
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  border-radius: 12px;
  box-shadow: 0 8px 16px rgba(0,0,0,0.08);
}

#allBookingsSection h2 {
  margin: 0 0 15px 0;
  font-size: clamp(1.1rem, 4vw, 1.3rem);
  color: #333;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

#allBookingsSection .refresh-info {
  font-size: clamp(0.8rem, 2.5vw, 0.95rem);
  color: #666;
  margin-bottom: 10px;
  padding: clamp(8px, 2vw, 12px);
  background: rgba(255,255,255,0.6);
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

#allBookingsSection .refresh-info i {
  animation: spin 2s linear infinite;
  flex-shrink: 0;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.all-bookings-container {
  display: grid;
  gap: 12px;
  max-height: 400px;
  overflow-y: auto;
  padding-right: 8px;
}

.all-bookings-container::-webkit-scrollbar {
  width: 6px;
}

.all-bookings-container::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.05);
  border-radius: 10px;
}

.all-bookings-container::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
}

.all-booking-card {
  padding: clamp(12px, 3vw, 16px);
  background: white;
  border-radius: 10px;
  border-left: 4px solid #4CAF50;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s ease;
  cursor: pointer;
  flex-wrap: wrap;
  gap: 12px;
}

.all-booking-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transform: translateX(2px);
}

.all-booking-card.pending {
  border-left-color: #FF9800;
}

.all-booking-card.confirmed {
  border-left-color: #4CAF50;
}

.all-booking-card.expanded {
  flex-direction: column;
  align-items: flex-start;
  gap: 12px;
}

.booking-info {
  flex: 1;
  width: 100%;
}

.booking-date-time {
  font-weight: 600;
  color: #333;
  font-size: clamp(0.85rem, 2vw, 0.95rem);
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.booking-date-time i {
  color: #4CAF50;
  flex-shrink: 0;
}

.booking-person {
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  color: #666;
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  word-break: break-all;
}

.booking-person i {
  flex-shrink: 0;
}

.booking-status-badge {
  padding: clamp(4px, 1vw, 6px) clamp(8px, 2vw, 12px);
  border-radius: 20px;
  font-size: clamp(0.65rem, 1.5vw, 0.8rem);
  font-weight: 600;
  text-transform: uppercase;
  white-space: nowrap;
  flex-shrink: 0;
}

.booking-status-badge.pending {
  background: #FFE0B2;
  color: #E65100;
}

.booking-status-badge.confirmed {
  background: #C8E6C9;
  color: #2E7D32;
}

.booking-actions {
  display: none;
  width: 100%;
  gap: clamp(8px, 2vw, 12px);
  margin-top: 10px;
  flex-direction: row;
  flex-wrap: nowrap;
}

.all-booking-card.expanded .booking-actions {
  display: flex;
}

.booking-actions button {
  flex: 1;
  min-width: 0;
  padding: clamp(10px, 2.5vw, 12px) clamp(12px, 3vw, 16px);
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: clamp(0.8rem, 2vw, 0.9rem);
  transition: all 0.2s ease;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.booking-actions .confirm {
  background: #4CAF50;
  color: white;
}

.booking-actions .confirm:hover {
  background: #45a049;
}

.booking-actions .confirm:active {
  transform: scale(0.98);
}

.booking-actions .delete {
  background: #f44336;
  color: white;
}

.booking-actions .delete:hover {
  background: #da190b;
}

.booking-actions .delete:active {
  transform: scale(0.98);
}

.empty-bookings {
  text-align: center;
  padding: clamp(20px, 8vw, 40px);
  color: #999;
  font-style: italic;
  font-size: clamp(0.9rem, 2vw, 1rem);
}

.empty-bookings i {
  font-size: clamp(1.5rem, 8vw, 2.5rem);
  margin-bottom: 10px;
  display: block;
  opacity: 0.5;
}

/* All Available Slots Section */
#allAvailableSlotsSection {
  margin-top: clamp(20px, 5vh, 30px);
  padding: clamp(16px, 4vw, 24px);
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
  border-radius: 12px;
  box-shadow: 0 8px 16px rgba(0,0,0,0.08);
}

#allAvailableSlotsSection h2 {
  margin: 0 0 15px 0;
  font-size: clamp(1.1rem, 4vw, 1.3rem);
  color: #1b5e20;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.available-slots-container {
  display: grid;
  gap: 10px;
  max-height: 300px;
  overflow-y: auto;
  padding-right: 8px;
}

.available-slots-container::-webkit-scrollbar {
  width: 6px;
}

.available-slots-container::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.05);
  border-radius: 10px;
}

.available-slots-container::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
}

.available-slot-card {
  padding: clamp(12px, 3vw, 16px);
  background: white;
  border-radius: 10px;
  border-left: 4px solid #4CAF50;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s ease;
  gap: 12px;
  flex-wrap: wrap;
}

.available-slot-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.available-slot-info {
  flex: 1;
  min-width: 150px;
}

.available-slot-date {
  font-weight: 600;
  color: #1b5e20;
  font-size: clamp(0.85rem, 2vw, 0.95rem);
  display: flex;
  align-items: center;
  gap: 8px;
}

.available-slot-date i {
  color: #4CAF50;
}

.available-slot-times {
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  color: #558b2f;
  margin-top: 4px;
}

.available-slot-remove-btn {
  background: #f44336;
  color: white;
  border: none;
  padding: clamp(8px, 2vw, 10px) clamp(12px, 3vw, 16px);
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  transition: all 0.2s ease;
  min-height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  flex-shrink: 0;
}

.available-slot-remove-btn:hover {
  background: #da190b;
}

.available-slot-remove-btn:active {
  transform: scale(0.98);
}

.empty-slots-message {
  text-align: center;
  padding: clamp(20px, 8vw, 30px);
  color: #999;
  font-style: italic;
  font-size: clamp(0.9rem, 2vw, 1rem);
}

/* Mobile responsive adjustments */
@media (max-width: 640px) {
  .admin-container {
    margin: 12px auto;
    border-radius: 10px;
  }

  .all-booking-card {
    flex-direction: column;
    align-items: flex-start;
  }

  .booking-status-badge {
    align-self: flex-start;
  }

  .all-booking-card:not(.expanded) .booking-status-badge {
    margin-left: auto;
  }

  .booking-actions button {
    min-width: calc(50% - 6px);
  }
}

@media (max-width: 480px) {
  .admin-container {
    padding: 14px 10px;
  }

  .admin-slots {
    grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
  }

  .admin-slot {
    font-size: 0.7rem;
    padding: 6px 4px;
  }

  .booking-actions {
    flex-direction: column;
  }

  .booking-actions button {
    width: 100%;
  }

  .all-bookings-container {
    max-height: 300px;
  }
}
  margin: 0 0 15px 0;
  font-size: 1.3rem;
  color: #333;
  display: flex;
  align-items: center;
  gap: 10px;
}

#allBookingsSection .refresh-info {
  font-size: 0.85rem;
  color: #666;
  margin-bottom: 10px;
  padding: 8px 12px;
  background: rgba(255,255,255,0.6);
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
}

#allBookingsSection .refresh-info i {
  animation: spin 2s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.all-bookings-container {
  display: grid;
  gap: 12px;
  max-height: 400px;
  overflow-y: auto;
  padding-right: 8px;
}

.all-bookings-container::-webkit-scrollbar {
  width: 6px;
}

.all-bookings-container::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.05);
  border-radius: 10px;
}

.all-bookings-container::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
}

.all-booking-card {
  padding: 14px;
  background: white;
  border-radius: 10px;
  border-left: 4px solid #4CAF50;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s ease;
  cursor: pointer;
}

.all-booking-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transform: translateX(2px);
}

.all-booking-card.pending {
  border-left-color: #FF9800;
}

.all-booking-card.confirmed {
  border-left-color: #4CAF50;
}

.all-booking-card.expanded {
  flex-direction: column;
  align-items: flex-start;
  gap: 12px;
}

.booking-info {
  flex: 1;
  width: 100%;
}

.booking-date-time {
  font-weight: 600;
  color: #333;
  font-size: 0.95rem;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.booking-date-time i {
  color: #4CAF50;
}

.booking-person {
  font-size: 0.85rem;
  color: #666;
  display: flex;
  align-items: center;
  gap: 6px;
}

.booking-status-badge {
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  margin-right: 10px;
}

.booking-status-badge.pending {
  background: #FFE0B2;
  color: #E65100;
}

.booking-status-badge.confirmed {
  background: #C8E6C9;
  color: #2E7D32;
}

.booking-actions {
  display: none;
  width: 100%;
  gap: 10px;
  margin-top: 10px;
}

.all-booking-card.expanded .booking-actions {
  display: flex;
}

.booking-actions button {
  flex: 1;
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.85rem;
  transition: all 0.2s ease;
}

.booking-actions .confirm {
  background: #4CAF50;
  color: white;
}

.booking-actions .confirm:hover {
  background: #45a049;
}

.booking-actions .delete {
  background: #f44336;
  color: white;
}

.booking-actions .delete:hover {
  background: #da190b;
}

.empty-bookings {
  text-align: center;
  padding: 30px 20px;
  color: #999;
  font-style: italic;
}

.empty-bookings i {
  font-size: 2rem;
  margin-bottom: 10px;
  display: block;
  opacity: 0.5;
}
</style>
</head>
<body>
<div class="admin-container">
  <img src="logo.png" alt="Logo" style="display:block;margin:0 auto 10px;width:clamp(80px, 25vw, 140px);">
  <h1>Admin - Manage Slots & Bookings</h1>

  <label>Select Date</label>
  <input type="date" id="adminDate">

  <label>Available Slots (08:00-20:00)</label>
  <div class="admin-slots" id="adminSlots"></div>

  <button id="saveSlots" style="margin-top: 12px; margin-bottom: 20px;">Save Slots</button>

  <div id="allAvailableSlotsSection">
    <h2><i class="fas fa-list-check"></i> All Available Slots</h2>
    <div class="available-slots-container" id="allAvailableSlots"></div>
  </div>

  <div id="allBookingsSection">
    <h2><i class="fas fa-calendar-check"></i> All Bookings</h2>
    <div class="all-bookings-container" id="allBookings"></div>
  </div>
</div>

<script>
const PHP_PATH='php/';
let selectedDate=null;
let autoRefreshInterval=null;
const REFRESH_INTERVAL=5000; // 5 seconds
let expandedBooking=null;
let previousBookingIds=new Set();

// Fetch JSON
async function getAvailableSlots(){ return await (await fetch(PHP_PATH+'getSlots.php')).json(); }
async function getBookings(){ return await (await fetch(PHP_PATH+'getBookings.php')).json(); }
async function saveAvailableSlots(slots){ await fetch(PHP_PATH+'saveSlots.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(slots)});}
async function saveBookings(bookings){ await fetch(PHP_PATH+'saveBookings.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(bookings)});}

// Override confirm to pause auto-refresh during dialog
const originalConfirm=window.confirm;
window.confirm=function(message){
  stopAutoRefresh();
  const result=originalConfirm(message);
  // Resume refresh after dialog closes
  setTimeout(()=>startAutoRefresh(), 100);
  return result;
};

// --- generate 08:00-20:00 hourly slots ---
function createAdminSlots(){
  const container=document.getElementById('adminSlots');
  if(!container) return;
  container.innerHTML='';
  for(let h=8;h<=20;h++){
    const div=document.createElement('div');
    div.className='admin-slot';
    const t=`${String(h).padStart(2,'0')}:00-${String(h).padStart(2,'0')}:40`;
    div.textContent=t;
    div.onclick=()=>div.classList.toggle('selected');
    container.appendChild(div);
  }
}

// --- render all available slots ---
async function renderAllAvailableSlots(){
  const container=document.getElementById('allAvailableSlots');
  const slotsData=await getAvailableSlots();
  container.innerHTML='';
  
  const slotArray=[];
  
  // Collect all slots by date
  Object.keys(slotsData).forEach(date=>{
    if(slotsData[date] && slotsData[date].length>0){
      slotArray.push({date, slots: slotsData[date]});
    }
  });
  
  if(slotArray.length===0){
    container.innerHTML=`
      <div class="empty-slots-message">
        <i class="fas fa-inbox"></i>
        <p>No available slots yet</p>
      </div>
    `;
    return;
  }
  
  // Sort by date
  slotArray.sort((a,b)=>new Date(a.date)-new Date(b.date));
  
  // Render slots
  slotArray.forEach(({date, slots})=>{
    const card=document.createElement('div');
    card.className='available-slot-card';
    
    const timesText=slots.join(', ');
    
    card.innerHTML=`
      <div class="available-slot-info">
        <div class="available-slot-date">
          <i class="fas fa-calendar"></i>
          ${date}
        </div>
        <div class="available-slot-times">
          ${timesText}
        </div>
      </div>
      <button class="available-slot-remove-btn" data-date="${date}">
        <i class="fas fa-times"></i> Remove
      </button>
    `;
    
    const removeBtn=card.querySelector('.available-slot-remove-btn');
    removeBtn.addEventListener('click', async (e)=>{
      e.stopPropagation();
      if(!confirm(`Remove all slots for ${date}?`)) return;
      
      let slotsDataCopy=await getAvailableSlots();
      delete slotsDataCopy[date];
      await saveAvailableSlots(slotsDataCopy);
      renderAllAvailableSlots();
    });
    
    container.appendChild(card);
  });
}

// --- simple hash function for stable booking IDs ---
function hashBooking(date, booking){
  let hash=0;
  const str=`${date}-${booking}`;
  for(let i=0; i<str.length; i++){
    const char=str.charCodeAt(i);
    hash=((hash<<5)-hash)+char;
    hash=hash & hash;
  }
  return 'bk-' + Math.abs(hash).toString(36);
}

// --- render all bookings with modern styling and click expansion ---
async function renderAllBookings(){
  const allBookingsDiv=document.getElementById('allBookings');
  const bookings=await getBookings();
  
  let totalBookings=0;
  const bookingArray=[];
  const currentBookingIds=new Set();
  
  // Collect all bookings with their index info for deletion
  Object.keys(bookings).forEach(date=>{
    if(bookings[date] && bookings[date].length>0){
      bookings[date].forEach((b, index)=>{
        totalBookings++;
        const bookingId=hashBooking(date, b);
        currentBookingIds.add(bookingId);
        bookingArray.push({date, booking: b, index, bookingId});
      });
    }
  });
  
  if(totalBookings===0){
    allBookingsDiv.innerHTML=`
      <div class="empty-bookings">
        <i class="fas fa-inbox"></i>
        <p>No bookings yet</p>
      </div>
    `;
    previousBookingIds.clear();
    return;
  }
  
  // Remove empty state if it exists
  const emptyState=allBookingsDiv.querySelector('.empty-bookings');
  if(emptyState) emptyState.remove();
  
  // Save the ID of the currently expanded booking before clearing
  const expandedBookingId=expandedBooking?.getAttribute('data-booking-id') || null;
  
  // Clear existing cards
  allBookingsDiv.innerHTML='';
  
  // Sort by date (newest first)
  bookingArray.sort((a,b)=>new Date(b.date)-new Date(a.date));
  
  // Render all bookings
  bookingArray.forEach(({date, booking, index, bookingId})=>{
    // Check if this is a new booking
    const isNewBooking=!previousBookingIds.has(bookingId);
    
    // Extract email if available
    const emailMatch=booking.match(/\(([^)]+)\)$/);
    const email=emailMatch?emailMatch[1]:'N/A';
    
    // Extract name/details
    const details=booking.replace(/\s*\([^)]+\)$/,'');
    
    // Create new card
    const div=document.createElement('div');
    div.className='all-booking-card pending';
    div.setAttribute('data-booking-id', bookingId);
    
    // Restore expanded state if this was the expanded booking
    if(bookingId===expandedBookingId){
      div.classList.add('expanded');
    }
    
    if(isNewBooking){
      div.classList.add('new-booking');
    }
    
    div.innerHTML=`
      <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
        <div class="booking-info">
          <div class="booking-date-time">
            <i class="fas fa-clock"></i>
            ${date} - ${details}
          </div>
          <div class="booking-person">
            <i class="fas fa-envelope"></i>
            ${email}
          </div>
        </div>
        <div class="booking-status-badge pending">
          Pending
        </div>
      </div>
      <div class="booking-actions">
        <button class="confirm" data-booking-id="${bookingId}" data-date="${date}" data-index="${index}" data-email="${email}">
          <i class="fas fa-check"></i> Confirm
        </button>
        <button class="delete" data-booking-id="${bookingId}" data-date="${date}" data-index="${index}">
          <i class="fas fa-trash"></i> Delete
        </button>
      </div>
    `;
    
    // Click handler to expand/collapse
    div.addEventListener('click', (e)=>{
      // Don't expand if clicking on a button
      if(e.target.closest('button')) return;
      
      // Close previously expanded booking
      if(expandedBooking && expandedBooking !== div){
        expandedBooking.classList.remove('expanded');
      }
      
      // Toggle current booking
      div.classList.toggle('expanded');
      
      expandedBooking=div.classList.contains('expanded')?div:null;
    });
    
    // Confirm button handler
    const confirmBtn=div.querySelector('.confirm');
    confirmBtn.addEventListener('click', async (e)=>{
      e.stopPropagation();
      const email=confirmBtn.dataset.email;
      const bookingDate=confirmBtn.dataset.date;
      const bookingDetails=booking;
      
      if(!confirm(`Are you sure? This will send a confirmation email to ${email}`)) return;
      
      await fetch(PHP_PATH+'sendEmail.php',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({email:email,slot:bookingDetails,date:bookingDate})
      });
      alert(`Email sent to ${email}`);
      renderAllBookings();
      renderAllAvailableSlots();
    });
    
    // Delete button handler
    const deleteBtn=div.querySelector('.delete');
    deleteBtn.addEventListener('click', async (e)=>{
      e.stopPropagation();
      const bookingDate=deleteBtn.dataset.date;
      const bookingIndex=parseInt(deleteBtn.dataset.index);
      
      if(!confirm('Are you sure you want to delete this booking?')) return;
      
      let bookingsData=await getBookings();
      bookingsData[bookingDate].splice(bookingIndex, 1);
      await saveBookings(bookingsData);
      
      // Also re-add slot to available slots
      const slotsData=await getAvailableSlots();
      const slotTime=booking.split(' - ')[0];
      slotsData[bookingDate]=slotsData[bookingDate]||[];
      if(!slotsData[bookingDate].includes(slotTime)) slotsData[bookingDate].push(slotTime);
      await saveAvailableSlots(slotsData);
      
      renderAllBookings();
      renderAllAvailableSlots();
    });
    
    allBookingsDiv.appendChild(div);
  });
  
  // Restore the expanded booking reference to the new DOM element
  if(expandedBookingId){
    expandedBooking=document.querySelector(`[data-booking-id="${expandedBookingId}"]`);
  }
  
  // Update previous booking IDs for next refresh
  previousBookingIds=currentBookingIds;
}

// --- render available slots for selected date ---
async function renderBookings(){
  if(!selectedDate) return;
  
  // Render all bookings and available slots
  renderAllBookings();
  renderAllAvailableSlots();
}

// --- Start auto-refresh for all bookings and available slots ---
function startAutoRefresh(){
  if(autoRefreshInterval) clearInterval(autoRefreshInterval);
  autoRefreshInterval=setInterval(()=>{
    renderAllBookings();
    renderAllAvailableSlots();
  }, REFRESH_INTERVAL);
}

// --- Stop auto-refresh ---
function stopAutoRefresh(){
  if(autoRefreshInterval){
    clearInterval(autoRefreshInterval);
    autoRefreshInterval=null;
  }
}

// --- on date change ---
document.getElementById('adminDate').onchange=async ()=>{
  selectedDate=document.getElementById('adminDate').value;
  createAdminSlots();
  const slotsData=await getAvailableSlots();
  document.querySelectorAll('.admin-slot').forEach(d=>{
    if(slotsData[selectedDate] && slotsData[selectedDate].includes(d.textContent)) d.classList.add('selected');
  });
  renderAllBookings();
  renderAllAvailableSlots();
};

// --- save slots ---
document.getElementById('saveSlots').onclick=async ()=>{
  if(!selectedDate){ alert('Select date'); return; }
  const selectedTimes=Array.from(document.querySelectorAll('.admin-slot.selected')).map(d=>d.textContent);
  const slotsData=await getAvailableSlots();
  slotsData[selectedDate]=selectedTimes;
  await saveAvailableSlots(slotsData);
  alert('Slots saved');
};

// Initialize
createAdminSlots();
renderAllAvailableSlots();
startAutoRefresh();

// Stop auto-refresh when page is hidden, resume when visible
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden) stopAutoRefresh();
  else startAutoRefresh();
});
</script>
</body>
</html>
